<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AO3 Mod Tools – Purimgifts Unrevealed Export</title>
  <style>
    :root {
      --ao3-red: #990000;
      --ao3-light: #f7f3f0;
      --border: #ddd;
      --text: #222;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: #faf7f6;
      color: var(--text);
      margin: 0;
      padding: 2.5rem 1rem;
      display: flex;
      justify-content: center;
    }
    .card {
      background: white;
      max-width: 840px;
      width: 100%;
      padding: 2rem 2.2rem;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      border: 1px solid #e3d7cf;
    }
    h1 {
      font-size: 1.7rem;
      color: var(--ao3-red);
      margin: 0 0 0.6rem;
    }
    h2 {
      font-size: 1.2rem;
      margin: 1.4rem 0 0.4rem;
      color: #444;
    }
    p {
      margin: 0.3rem 0;
    }
    .badge {
      display: inline-block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: var(--ao3-light);
      color: var(--ao3-red);
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #e2d2ca;
      margin-bottom: 0.6rem;
    }
    .bookmarklet {
      display: inline-block;
      margin: 0.8rem 0 1.2rem;
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      background: var(--ao3-red);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      border: 1px solid #5f0000;
      box-shadow: 0 4px 10px rgba(153,0,0,0.25);
      cursor: grab;
    }
    .bookmarklet:hover {
      background: #b30000;
    }
    .bookmarklet:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(153,0,0,0.3);
      cursor: grabbing;
    }
    ol {
      padding-left: 1.2rem;
      margin: 0.25rem 0 0.8rem;
    }
    li { margin: 0.15rem 0; }
    code {
      background: #f5f2ef;
      padding: 0.1rem 0.25rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    textarea {
      width: 100%;
      height: 7rem;
      margin-top: 0.4rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      padding: 0.45rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fdfaf8;
      resize: vertical;
    }
    .note {
      font-size: 0.85rem;
      color: #555;
    }
    .footer {
      margin-top: 1.4rem;
      padding-top: 0.8rem;
      border-top: 1px dashed #e0d0c6;
      font-size: 0.8rem;
      color: #777;
    }
    ul {
      margin: 0.25rem 0 0.8rem;
      padding-left: 1.2rem;
    }
    ul li {
      margin: 0.15rem 0;
    }
  </style>
</head>
<body>
  <main class="card">
    <span class="badge">AO3 Collection Moderator Tool</span>
    <h1>Purimgifts – Unrevealed Multi-page Export</h1>
    <p>
      This bookmarklet helps Purimgifts moderators export all <strong>Approved</strong> items
      from the AO3 “Manage Items” view into a single CSV file – even if the Approved
      list spans several pages.
    </p>
    <p>
      It walks through all pages of the Approved tab and, for non-draft works,
      also visits each work page in <strong>“Entire Work” view</strong> to fetch fandoms,
      tags, day tags, summary text, and detailed information about embedded images
      or media (including counts). You can open the CSV in Excel, Google Sheets,
      or LibreOffice to plan reveals and scheduling.
    </p>

    <h2>What this script actually does</h2>
    <p>For every item listed in <strong>Manage Items → Approved</strong>, the export includes:</p>
    <ul>
      <li><strong>Title</strong> – exactly as shown in the Approved list (including “(Draft)” if present)</li>
      <li><strong>Is Draft</strong> – <code>yes</code> if the title ends with <code>(Draft)</code>, otherwise empty</li>
      <li><strong>Creator</strong> – the name shown in the header (without the “for &lt;recipient&gt;” part)</li>
      <li><strong>Link</strong> – direct link to the work on AO3</li>
      <li><strong>Recipient</strong> – the giftee / recipient (“for &lt;user&gt;”), if present</li>
      <li><strong>Posting Date</strong> – the date shown in the Approved list</li>
      <li><strong>creator_status</strong> – e.g. “Approved by creator”</li>
      <li><strong>collection_status</strong> – e.g. “Approved by collection moderators”</li>
      <li><strong>unrevealed</strong> – <code>unrevealed</code> if the checkbox is ticked, otherwise <code>revealed</code></li>
      <li><strong>Day Tag</strong> – one of the Purimgifts day tags, if present:
        <ul>
          <li><code>Collection: Purimgifts Day 1</code></li>
          <li><code>Collection: Purimgifts Day 2</code></li>
          <li><code>Collection: Purimgifts Day 3</code></li>
          <li><code>Collection: Purimgifts Extras</code></li>
        </ul>
        If none of these are present among the additional tags, this column is left blank.
      </li>
      <li><strong>Image Count</strong> – the total number of <code>&lt;img&gt;</code> tags in the work content
        (counted in “Entire Work” view across all chapters)</li>
      <li><strong>Has Images</strong> – <code>yes</code> if <strong>Image Count &gt; 0</strong>, otherwise <code>no</code></li>
      <li><strong>Media Count</strong> – the total number of embedded media elements in the work content
        (<code>&lt;audio&gt;</code>, <code>&lt;video&gt;</code>, <code>&lt;iframe&gt;</code>, <code>&lt;embed&gt;</code>,
        again in “Entire Work” view across all chapters)</li>
      <li><strong>Has Media</strong> – <code>yes</code> if <strong>Media Count &gt; 0</strong>, otherwise <code>no</code></li>
      <li><strong>Fandoms</strong> – all fandom tags from the work page</li>
      <li><strong>Category</strong> – Gen / F/M / M/M / F/F etc.</li>
      <li><strong>Relationships</strong></li>
      <li><strong>Characters</strong></li>
      <li><strong>Tags</strong> – the additional tags / freeforms (including the day tag, even though it is also broken out separately)</li>
      <li><strong>Rating</strong></li>
      <li><strong>Warnings</strong></li>
      <li><strong>Words</strong></li>
      <li><strong>Chapters</strong> – preserved in the current <code>="current/total"</code> format</li>
      <li><strong>Summary</strong> – the work summary text (without an extra “Summary:” prefix)</li>
    </ul>
    <p class="note">
      The day tag is pulled specifically from the freeform/additional tags. The script looks
      for an exact match to the four Purimgifts collection day tags listed above and copies
      the matching one into the <strong>Day Tag</strong> column.
    </p>
    <p class="note">
      You can also safely run this on other collections. On non-Purimgifts collections the
      <strong>Day Tag</strong> column will simply stay empty.
    </p>

    <h2>Drafts and AO3 quirks</h2>
    <p>
      AO3 can show saved drafts in the collection “Manage Items” view, with <code>(Draft)</code>
      at the end of the title, even when the full work page is not accessible to moderators.
    </p>
    <ul>
      <li>The script marks such entries with <strong>Is Draft = yes</strong>.</li>
      <li>For drafts, it <strong>does not attempt to fetch work-page metadata</strong> (fandoms, tags, day tag, media counts/flags, etc.).</li>
      <li>This avoids pulling in incorrect data from error pages or unrelated works.</li>
      <li>If an author saves several drafts, they might appear multiple times; the CSV will show each occurrence so you can track or deduplicate as needed.</li>
    </ul>

    <h2>Drag-and-drop bookmarklet</h2>
    <p>Drag this button to your bookmarks bar:</p>

    <!-- SHORT LOADER BOOKMARKLET FOR PURIMGIFTS -->
    <p>
      <a class="bookmarklet"
         href="javascript:(function(){var s=document.createElement('script');s.src='https://larissabernstein.github.io/ao3_mod_tools_purimgifts_unrevealed.js?'+Date.now();document.body.appendChild(s);}());">
        AO3 Purimgifts – Unrevealed CSV
      </a>
    </p>

    <p class="note">
      When clicked on AO3, this bookmarklet loads the latest version of the
      Purimgifts export script from this site and downloads a CSV file.
    </p>

    <h2>How to use on AO3</h2>
    <ol>
      <li>Log in to AO3 and go to the Purimgifts collection’s <strong>Manage Items</strong> page.</li>
      <li>Click the <strong>Approved</strong> tab (the one with status dropdowns &amp; unrevealed checkboxes).</li>
      <li>Make sure you are on <strong>page&nbsp;1</strong> of the Approved list.</li>
      <li>Click the <em>AO3 Purimgifts – Unrevealed CSV</em> bookmarklet.</li>
      <li>Wait while it walks through all pages and (for non-drafts) the work pages in “Entire Work” view;
        when finished, a CSV will download as<br>
        <code>ao3_purimgifts_unrevealed_all_pages.csv</code>.
      </li>
    </ol>

    <h2>If dragging doesn’t work (Safari fallback)</h2>
    <p>
      If clicking the bookmark on AO3 does nothing, Safari may have stripped the code.
      In that case:
    </p>
    <ol>
      <li>Create a new bookmark (e.g. name it <code>AO3 Purimgifts – Unrevealed CSV</code>).</li>
      <li>Open <strong>Bookmarks → Edit Bookmarks</strong> and select the bookmark.</li>
      <li>Paste this into the URL / Address field and press Enter:</li>
    </ol>

    <textarea readonly>
javascript:(function(){var s=document.createElement('script');s.src='https://larissabernstein.github.io/ao3_mod_tools_purimgifts_unrevealed.js?'+Date.now();document.body.appendChild(s);}());
    </textarea>

    <p class="note">
      After that, use the bookmark on AO3 as described above.
    </p>

    <div class="footer">
      Version 1.2 – Purimgifts draft-aware unrevealed export with image/media counts.<br>
      Exports columns: Title, Is Draft, Creator, Link, Recipient, Posting Date,
      creator_status, collection_status, unrevealed, Day Tag, Image Count, Has Images,
      Media Count, Has Media, Fandoms, Category, Relationships, Characters,
      Tags (freeforms), Rating, Warnings, Words, Chapters, Summary.<br>
      Day Tag is taken from the additional tags if it matches one of:
      “Collection: Purimgifts Day 1”, “Collection: Purimgifts Day 2”,
      “Collection: Purimgifts Day 3”, “Collection: Purimgifts Extras”.<br>
      Created by Dr. Larissa Bernstein.
    </div>
  </main>
</body>
</html>
